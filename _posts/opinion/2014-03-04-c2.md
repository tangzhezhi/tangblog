---
layout: post
title:  JNA或者Jnative调用dll
category: opinion
description:   JNA或者Jnative调用dll
---

##									 JNA或者Jnative调用dll
首先写一个C++的小例子

```C++

	#ifndef _TEST_H__
	#define _TEST_H__
	
	#ifdef _MSC_VER
	   extern "C" _declspec(dllexport)  int add(int a,int b);
	#endif
	
	#ifdef __GNUC__
	     int add(int a,int b);
	#endif
	
	#endif


	#include <stdio.h>
	#include "test.h"
	
	  int add(int a, int b)
	{
	    printf("Doll function add() called\n");
	    return (a + b);
	}
```


然后
	gcc test.cpp test.dll -o test
这个时候就有了test.dll了。

然后就自己的调用jna来调用test.dll了。

```java
	package org.tang;
	
	import com.sun.jna.Library;
	import com.sun.jna.Native;
	
	// 使用32位jdk
	public class Test {
		 // 1.实现PegRoute.dll 文件接口  
	    
		
	    public interface test extends Library {  
	  
	        // 2.PegRoute.dll 中 HCTInitEx方法  
	        public int  add();  
	    }  
	      
	    public static void main(String[] args) {  
	                 //3.加载DLL文件，执行dll方法    
	    	test epen = (test) Native.loadLibrary("test",  
	    			test.class);  
	        if (epen != null) {  
	            System.out.println("DLL加载成功！");  
	            int success = epen.add();  
	            System.out.println("1.设备初始化信息！" + success);  
	                    }  
	    }  
	}
	
	



	import org.xvolks.jnative.JNative;
	import org.xvolks.jnative.Type;
	import org.xvolks.jnative.exceptions.NativeException;
	
	// 使用32位jdk
	public class Test2 {
	    public static int nativeAdd(int a,int b) throws NativeException, IllegalAccessException {
	        JNative n = null;
	        n = new JNative("test.dll", "_Z3addii");
	        n.setRetVal(Type.INT);
	        n.setParameter(0, a);
	        n.setParameter(1, b);
	        n.invoke();
	        System.out.println("返回: " + n.getRetVal());
	        return Integer.parseInt(n.getRetVal());
	    }
	    
	    public static void main(String[] args) {
	        try {
	            nativeAdd(1,3);
	        } catch (NativeException e) {
	            e.printStackTrace();
	        } catch (IllegalAccessException e) {
	            e.printStackTrace();
	        }
	    }
	}


```

这个时候会发现没有这个方法。可能的原因可以参考
dumpbin查看dll中函数名字的问题[1]

如果使用别人的dll发现问题的话，可以使用depends.exe
查看dll的依赖关系。

[1]http://www.examtom.com/c1/


